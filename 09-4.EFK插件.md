tags: addons, EFK, fluentd, elasticsearch, kibana

# 09-5.部署 EFK 插件

<!-- TOC -->

- [09-5.部署 EFK 插件](#09-5部署-efk-插件)
    - [修改配置文件](#修改配置文件)
    - [给 Node 打标签](#给-node-打标签)
    - [执行定义文件](#执行定义文件)
    - [检查执行结果](#检查执行结果)
    - [访问 kibana](#访问-kibana)

<!-- /TOC -->

注意：
1. 如果没有特殊指明，本文档的所有操作**均在 zhangjun-k8s01 节点上执行**。
2. kuberntes 自带插件的 manifests yaml 文件使用 gcr.io 的 docker registry，国内被墙，需要**手动替换**为其它 registry 地址；
3. 可以从微软中国提供的 [gcr.io 免费代理](http://mirror.azure.cn/help/gcr-proxy-cache.html)下载被墙的镜像；

## 修改配置文件

将下载的 kubernetes-server-linux-amd64.tar.gz 解压后，再解压其中的 kubernetes-src.tar.gz 文件。

``` bash
cd /opt/k8s/work/kubernetes/
tar -xzvf kubernetes-src.tar.gz
```

EFK 目录是 `kubernetes/cluster/addons/fluentd-elasticsearch`。

``` bash
$ cd /opt/k8s/work/kubernetes/cluster/addons/fluentd-elasticsearch
$ cp fluentd-es-ds.yaml  fluentd-es-ds.yaml.orig
$ diff fluentd-es-ds.yaml.orig fluentd-es-ds.yaml
105c105
<           path: /var/lib/docker/containers
---
>           path: /data/k8s/docker/data/containers/


# 把hostPath改下
  hostPath:
      path: /data/k8s/docker/data/containers/


# 修改镜像地址
sed -i  "s#k8s.gcr.io#registry.cn-hangzhou.aliyuncs.com\/google_containers#g" fluentd-es-ds.yaml

sed -i  "s#k8s.gcr.io#registry.cn-hangzhou.aliyuncs.com\/google_containers#g" es-statefulset.yaml

sed -i  "s#gcr.io\/fluentd-elasticsearch#docker.elastic.co\/elasticsearch#g" es-statefulset.yaml


```

## 给 Node 打标签

DaemonSet `fluentd-es` 只会调度到有 `beta.kubernetes.io/fluentd-ds-ready=true` 标签的 Node，故选择一个 Node 打上该标签：

``` bash
$ kubectl get nodes
NAME     STATUS   ROLES    AGE   VERSION
k8s-m1   Ready    <none>   22h   v1.14.3
k8s-m2   Ready    <none>   22h   v1.14.3
k8s-m3   Ready    <none>   22h   v1.14.3
k8s-n1   Ready    <none>   22h   v1.14.3


$ kubectl label nodes k8s-m3 beta.kubernetes.io/fluentd-ds-ready=true
```

## 执行定义文件

``` bash
$ pwd
/opt/k8s/work/kubernetes/cluster/addons/fluentd-elasticsearch
$ ls *.yaml
es-service.yaml  es-statefulset.yaml  fluentd-es-configmap.yaml  fluentd-es-ds.yaml  kibana-deployment.yaml  kibana-service.yaml
$ kubectl apply -f .
```

## 检查执行结果

``` bash
$ kubectl get pods -n kube-system -o wide|grep -E 'elasticsearch|fluentd|kibana'

elasticsearch-logging-0                 1/1     Running   1          87m   172.30.40.4    k8s-m3   <none>           <none>
elasticsearch-logging-1                 1/1     Running   1          72m   172.30.8.5     k8s-m1   <none>           <none>
fluentd-es-v2.4.0-4gspl                 1/1     Running   1          87m   172.30.40.3    k8s-m3   <none>           <none>
fluentd-es-v2.4.0-4kqtj                 1/1     Running   1          87m   172.30.208.3   k8s-n1   <none>           <none>
fluentd-es-v2.4.0-mkkcw                 1/1     Running   1          87m   172.30.8.4     k8s-m1   <none>           <none>
fluentd-es-v2.4.0-rknxf                 1/1     Running   1          87m   172.30.64.2    k8s-m2   <none>           <none>
kibana-logging-f4d99b69f-s8z8h          1/1     Running   2          87m   172.30.208.4   k8s-n1   <none>           <none>

$ kubectl get service  -n kube-system|grep -E 'elasticsearch|kibana'
elasticsearch-logging   ClusterIP   10.254.29.196   <none>        9200/TCP                 88m
kibana-logging          ClusterIP   10.254.17.86    <none>        5601/TCP                 88m
```

kibana Pod 第一次启动时会用**较长时间(0-20分钟)**来优化和 Cache 状态页面，可以 tailf 该 Pod 的日志观察进度：

``` bash
$  kubectl logs kibana-logging-f4d99b69f-s8z8h -n kube-system -f
{"type":"log","@timestamp":"2019-07-02T03:53:04Z","tags":["warning","config","deprecation"],"pid":1,"message":"You should set server.basePath along with server.rewriteBasePath. Starting in 7.0, Kibana will expect that all requests start with server.basePath rather than expecting you to rewrite the requests in your reverse proxy. Set server.rewriteBasePath to false to preserve the current behavior and silence this warning."}
{"type":"log","@timestamp":"2019-07-02T03:53:05Z","tags":["plugin","warning"],"pid":1,"path":"/usr/share/kibana/src/legacy/core_plugins/ems_util","message":"Skipping non-plugin directory at /usr/share/kibana/src/legacy/core_plugins/ems_util"}
{"type":"log","@timestamp":"2019-07-02T03:53:05Z","tags":["warning","elasticsearch","config","deprecation"],"pid":1,"message":"Config key \"url\" is deprecated. It has been replaced with \"hosts\""}
{"type":"log","@timestamp":"2019-07-02T03:53:05Z","tags":["status","plugin:kibana@6.6.1","info"],"pid":1,"state":"green","message":"Status changed from uninitialized to green - Ready","prevState":"uninitialized","prevMsg":"uninitialized"}
{"type":"log","@timestamp":"2019-07-02T03:53:05Z","tags":["status","plugin:elasticsearch@6.6.1","info"],"pid":1,"state":"yellow","message":"Status changed from uninitialized to yellow - Waiting for Elasticsearch","prevState":"uninitialized","prevMsg":"uninitialized"}
{"type":"log","@timestamp":"2019-07-02T03:53:05Z","tags":["status","plugin:console@6.6.1","info"],"pid":1,"state":"green","message":"Status changed from uninitialized to green - Ready","prevState":"uninitialized","prevMsg":"uninitialized"}
{"type":"log","@timestamp":"2019-07-02T03:53:05Z","tags":["status","plugin:interpreter@6.6.1","info"],"pid":1,"state":"green","message":"Status changed from uninitialized to green - Ready","prevState":"uninitialized","prevMsg":"uninitialized"}
{"type":"log","@timestamp":"2019-07-02T03:53:05Z","tags":["status","plugin:metrics@6.6.1","info"],"pid":1,"state":"green","message":"Status changed from uninitialized to green - Ready","prevState":"uninitialized","prevMsg":"uninitialized"}
{"type":"log","@timestamp":"2019-07-02T03:53:06Z","tags":["status","plugin:timelion@6.6.1","info"],"pid":1,"state":"green","message":"Status changed from uninitialized to green - Ready","prevState":"uninitialized","prevMsg":"uninitialized"}
{"type":"log","@timestamp":"2019-07-02T03:53:06Z","tags":["status","plugin:elasticsearch@6.6.1","info"],"pid":1,"state":"green","message":"Status changed from yellow to green - Ready","prevState":"yellow","prevMsg":"Waiting for Elasticsearch"}
{"type":"log","@timestamp":"2019-07-02T03:53:06Z","tags":["listening","info"],"pid":1,"message":"Server running at http://0:5601"}
```

注意：只有当 Kibana pod 启动完成后，浏览器才能查看 kibana dashboard，否则会被拒绝。

## 访问 kibana

1. 通过 kube-apiserver 访问：

    ``` bash
    $ kubectl cluster-info|grep -E 'Elasticsearch|Kibana'
    root@host00:~# kubectl cluster-info|grep -E 'Elasticsearch|Kibana'
    Elasticsearch is running at https://10.1.80.77:8443/api/v1/namespaces/kube-system/services/elasticsearch-logging/proxy
    Kibana is running at https://10.1.80.77:8443/api/v1/namespaces/kube-system/services/kibana-logging/proxy
    ```

    浏览器访问 URL： `https://10.1.80.77:8443/api/v1/namespaces/kube-system/services/kibana-logging/proxy`
    ~~对于 virtuabox 做了端口映射： `http://127.0.0.1:8080/api/v1/namespaces/kube-system/services/kibana-logging/proxy`

1. 通过 kubectl proxy 访问：

    创建代理

    ``` bash
    $ kubectl proxy --address='10.1.80.71' --port=8086 --accept-hosts='^*$'
    Starting to serve on 10.1.80.71:8086
    ```

    浏览器访问 URL：`http://10.1.80.71:8086/api/v1/namespaces/kube-system/services/kibana-logging/proxy`
    
    对于 virtuabox 做了端口映射： `http://127.0.0.1:8086/api/v1/namespaces/kube-system/services/kibana-logging/proxy`

在 Management -> Indices 页面创建一个 index（相当于 mysql 中的一个 database），选中 `Index contains time-based events`，使用默认的 `logstash-*` pattern，点击 `Create` ;

![es-setting](./images/es-setting.png)

创建 Index 后，稍等几分钟就可以在 `Discover` 菜单下看到 ElasticSearch logging 中汇聚的日志；

![es-home](./images/es-home.png)
